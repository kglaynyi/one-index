// export const AllDrivers: DriverConfig[] = [
//   {
//     path: "onedrivetwo", // should be unique for each driver , space not allowed ,
//     type: "onedrive",
//     refreshtoken:
//       "0.AagAp8cXKswNQEegOR1qWqfU_tONxnwqt8RJohtwP7Rj5VqoACc.AgABAAEAAAAmoFfGtYxvRrNriQdPKIZ-AgDs_wUA9P_vVXILAtoSNwvJ2jw4K65ohDiGUydMeq9k7yfrB5txEOev0kKWgklwbqjfiLkWwugECwcP4XhjQlUbmiW-Y1sJYSaSZgORoCWJGITlYKjDeDOHhIGEiLUU1fGKOa5w7m2LZqd2-VoARV7rXfMCAOJxsr7bw0YSU9mVx2xK8wjNhEgpmYhK1HjCX14QuJoDJm8GVCY3txQJnFFpPwpnP1KXZFPrL0eYME3W-ZWwyCuAXnsaRgvjjeUhiYwPPooXE3OXkLODY4fh18X4igNrMCgbenF0zlGKqxgGB1D69C6fWdxXLnh0hs_fzjhN5ToExESSO1jbxwRJLK8Q6BeXSS8mJYu79eTpWLugBLq0dM_kmPdCl1LtslIOhivBoHRcm7rdJgg96-_D2WO5VqBWFyvTJZJia0-QXktwNVPwVja95jQXrxDaBqD-Wmlc7RO9ibBBZK2esHPnK2dZUke1TJSec7al429q0Nk60qjia4ZDFJO9BhH164SS3shK2Pxk6uhZrU6yRdlunSc4vNbAg5Pu4kigvSF9Wc5el5G-WVhbjZQTSJsNWcydI8wNllijh_zbaKOiDDBdQ_UiZjxZ30Ve-jEIJKiuKew5_9Zmm8mRZT6YBreMioZubMiFMsEnRJ62G0mvp7ijilxqoZRva50sCcJ870w7P5SrhZkXd7CaLRGyOBt8-qvQwA9LrxX5xvIc_jf_b8JYcRIJVx3NW-fBaZy-x9VN9th0xVjaShX1euw2xckfEeLEQhj-Retfdn-f4fhGe0xtq1SGsoOdfRrljTOu",
//   },
//   {
//     path: "onedriveone", // should be unique for each driver , space not allowed ,
//     type: "onedrive",
//     refreshtoken:
//         "0.AagAp8cXKswNQEegOR1qWqfU_tONxnwqt8RJohtwP7Rj5VqoACc.AgABAAEAAAAmoFfGtYxvRrNriQdPKIZ-AgDs_wUA9P_vVXILAtoSNwvJ2jw4K65ohDiGUydMeq9k7yfrB5txEOev0kKWgklwbqjfiLkWwugECwcP4XhjQlUbmiW-Y1sJYSaSZgORoCWJGITlYKjDeDOHhIGEiLUU1fGKOa5w7m2LZqd2-VoARV7rXfMCAOJxsr7bw0YSU9mVx2xK8wjNhEgpmYhK1HjCX14QuJoDJm8GVCY3txQJnFFpPwpnP1KXZFPrL0eYME3W-ZWwyCuAXnsaRgvjjeUhiYwPPooXE3OXkLODY4fh18X4igNrMCgbenF0zlGKqxgGB1D69C6fWdxXLnh0hs_fzjhN5ToExESSO1jbxwRJLK8Q6BeXSS8mJYu79eTpWLugBLq0dM_kmPdCl1LtslIOhivBoHRcm7rdJgg96-_D2WO5VqBWFyvTJZJia0-QXktwNVPwVja95jQXrxDaBqD-Wmlc7RO9ibBBZK2esHPnK2dZUke1TJSec7al429q0Nk60qjia4ZDFJO9BhH164SS3shK2Pxk6uhZrU6yRdlunSc4vNbAg5Pu4kigvSF9Wc5el5G-WVhbjZQTSJsNWcydI8wNllijh_zbaKOiDDBdQ_UiZjxZ30Ve-jEIJKiuKew5_9Zmm8mRZT6YBreMioZubMiFMsEnRJ62G0mvp7ijilxqoZRva50sCcJ870w7P5SrhZkXd7CaLRGyOBt8-qvQwA9LrxX5xvIc_jf_b8JYcRIJVx3NW-fBaZy-x9VN9th0xVjaShX1euw2xckfEeLEQhj-Retfdn-f4fhGe0xtq1SGsoOdfRrljTOu",
//   },
//   {
//     path: "gdrive", // should be unique for each driver
//     type: "googledrive",
//     refreshtoken: "your_google_drive_refresh_token_here",
//   },
// ];

export const AllDrivers: DriverConfig[] = [
  {
    path: "NLIN", // should be unique for each driver , space not allowed ,
    type: "onedrive",
    refreshtoken:
      "0.AagAp8cXKswNQEegOR1qWqfU_mmjjjA8oRtLpB8yQtjDKomoACc.AgABAAEAAAAmoFfGtYxvRrNriQdPKIZ-AgDs_wUA9P8VnlADoxWSW-Jls0N17N5uXU4KNckXrq_sMEuJaJFVMY2bmlkJvj_UWfF9ETqcNLqHWaBeF4OKYcS5Y2UKjJfK2GBy0dae6fTZP3l0e5h6ME1YI2Qmb7reFt-JA5L6HbTWVIo8YAVufIo0AZ1mfnO2KcSlhtN0zcXDinK1Fij9DJtvbXn7ns3-PU75fuTducNs7bgstfXF3pzlhg3sHL53acMhLbEmQD_RU-9APMPZpxCTB1B-Zt0TA9WhpNVQcNPrUJTQP2tuicB0o-EMaJM9sXux69A-SQlX8-7cJqdzSKG0DNYnjTDOCNcYIB8VOgsoVpBE-xi9OHeP3Y6nZwJTQUVFq3YvB7OTvCZwtyV8b-rMo6jVIqaE32mJiuZ5zivJIZxwHL9W9_IfDcG9RYi3g7-PL9JSiwYL_FaZB24-32harDg2jgz7ayxS4puiEfggxtbz-cA6eSuHqxrniafJr96JiHhDiuZgJDhuGJ9pcV7B5fqxKGCqT_rcuKQg8DZ-SNYq5tbOCY9O2p4BKEV6P1wiuzZYz2ui6rFibdkqizloCd0Ca3m0L5Yu0Oup275wnCxtMBjqdWLebl9upPh2dv6f75FIxXh8Rrniw7hW_rT0TlNSdiuFiMr2j9o0GXrv_5idbxSuP9iULgJxilywJlrD5_tR60YnlOyMs4BVKXiy4L-TjEomhDy4C37Fx8paS85jXOaBA-5CfRdA4k1KlwkzDMXD9d04Gi3Xl_p6-8VvIxEsBD6RV2sQ1cXSlbT5HwAjKA3YQWB8e51Oco1KKIcTCLV6nfSF3v3I_cU0Ejs",
  },
  {
    path: "onedriveone", // should be unique for each driver , space not allowed ,
    type: "onedrive",
    refreshtoken:
      "0.AUoAJGMhXWgu7E-pXfpN7WNVxqORKQp0FjRDhWFnHMc0mWCJAJY.AgABAAEAAAAmoFfGtYxvRrNriQdPKIZ-AgDs_wUA9P-R8QXtGjxcpDuTmNQeS0pou7R20FnzY_-fyFnuTa3KD0jarC1EUt_z6HnDepwrJlh4RA3Z72LZrl14WAjO2pg3bOwXV_30Nuo2jUEkd73ogOhqOj3dYqtNravKr1EC3GqlXvg3jwfT6_cCSDXjxWOAaeZhp_6X4dJVnAjuBdPc2f0tf4KCuA-zW-G4tpJmeJya2Yx98VRqnQfzNfVBazsemDf8U1trqhsMyuWMZTxFXSIMJf5Y7MtecQeNWx0wMXteJTeZxsQSZXTxdgW92ibFSHecrMPahVFXnllmr5hr0DWFB6nRKWy76MXrWoNLfdmgx-LiM7Cz_Rfa5gmN6LR8Pia2A0vW5JW6TDG-WAe1wP0lM-ZrizQuaytBFoxEZiKYHY5yRhzPLbNlSDcOVjzeO8BhJTKi2jtr4SCk4NjPg7D72vJ5pcTmrVG6NKNobyuZb7lkA323irBpgPR6MAGFZD4T4AP3_eG4EvNMI8DsqK1KOaGTLyXDcP95vJxTuLeJTNb8m7ky7yacTbeBmQGc7kCzZJJ4J8y77EX3wWf5xTwJ7IsZcIExa-M8neGM6HcbblUzH6d4Ab8y68DX8wMji7Ue15pmaZeVS0G4nJELmQFt9esb6IOnONEY1AJg8Ftpa0VE_Kb1CbfEMiSX5XqHFO4U-O7Q6U_Qwix9lYqssvXYIoQcXpv6SJq65BlqCp9I3m-WTR6m4EuFTvjgL17xz82VR3PwsWtls-qL17RXY45TuhD7gSr4Ix1FfwRpJ26zI1Em95OMyVtk3B9p8KkW",
  },
  {
    path: "gdrive", // should be unique for each driver
    type: "googledrive",
    refreshtoken: "your_google_drive_refresh_token_here",
  },
];

// __ Dot Touch __ if you don't know what you are doing below
interface DriverIF {
  List(id?: string): Promise<DriveList[]>; // id is optional
  Search(name: string): Promise<DriveList[]>;

  GetFile(id: string, request: any): Promise<Response>;
}

export interface DriveList {
  name: string;
  id: string;
  size: number;
  type: string;
}

interface DriverConfig {
  path: string;
  type: "onedrive" | "googledrive";
  refreshtoken: string;
}

//  get driver by path
export function GetDriver(path: string): DriverIF {
  const driver = AllDrivers.find((d) => {
    return d.path === path;
  });
  if (!driver) {
    throw new Error("Driver not found");
  }

  switch (driver.type) {
    case "onedrive":
      return new OneDrive(driver.refreshtoken);
    case "googledrive":
      return new GDrive(driver.refreshtoken);
    default:
      throw new Error("Driver not found");
  }
}

class OneDrive implements DriverIF {
  private accessToken: string;
  private readonly refreshToken: string;

  constructor(refreshToken: string) {
    this.refreshToken = refreshToken;
  }

  private async loadToken() {
    try {
      const token = await this.fetchAccessToken(this.refreshToken);
      this.accessToken = token;
      return token;
    } catch (error) {
      console.log("error", error);
      throw new Error("Error fetching access token");
    }
  }

  private async fetchAccessToken(refreshToken: string): Promise<string> {
    // this.accesstoken =   (refreshToken):string => {
    const client_id = "0a2991a3-1674-4334-8561-671cc7349960";
    const client_secret = "uw67Q~TCMqdJyH35hlcHHclv~mhNOGx.jfPFm";
    const redirect_uri = "https://alist.nn.ci/tool/onedrive/callback";
    const token_url =
      "https://login.microsoftonline.com/common/oauth2/v2.0/token";
    const req = await fetch(token_url, {
      method: "POST",
      body: `client_id=${client_id}&scope=offline_access%20Files.ReadWrite.All&refresh_token=${refreshToken}&redirect_uri=${redirect_uri}&grant_type=refresh_token&client_secret=${client_secret}`,
      headers: {
        "Content-Type": "application/x-www-form-urlencoded",
      },
    });
    const data = await req.json();
    this.accessToken = data.access_token;

    return data.access_token;
  }

  async List(id?: string): Promise<DriveList[]> {
    if (!this.accessToken) {
      await this.loadToken();
    }
    let url = "";
    if (id) {
      url = `https://graph.microsoft.com/v1.0/me/drive/items/${id}/children?$top=5000&$expand=thumbnails($select=medium)&$select=id,name,size,lastModifiedDateTime,content.downloadUrl,file,parentReference`;
    } else {
      url =
        "https://graph.microsoft.com/v1.0/me/drive/root/children?$top=5000&$expand=thumbnails($select=medium)&$select=id,name,size,lastModifiedDateTime,content.downloadUrl,file,parentReference";
    }
    const request = await fetch(url, {
      headers: {
        Authorization: `Bearer ${this.accessToken}`,
      },
    });

    const data = await request.json();
    // console.log("data", data)
    //    get length of data
    console.log("data.value.length", data.value.length);

    return data.value.map((item: any) => {
      return {
        name: item.name,
        size: item.size,
        id: item.id,
        type: item.file ? "file" : "folder",
      };
    });
  }

  async GetFile(id: string, request: any): Promise<Response> {
    if (!this.accessToken) {
      await this.loadToken();
    }
    const url = `https://graph.microsoft.com/v1.0/me/drive/items/${id}/content`;
    const myheaders = {
      Authorization: `Bearer ${this.accessToken}`,
    };
    try {
      if (request.headers.get("Range" || "range")) {
        console.log("got partial content request");
        myheaders["Range"] = request.headers.get("Range" || "range");
        const response = await fetch(url, { headers: myheaders });
        const contentRange = response.headers.get("Content-Range");
        const contentLength = response.headers.get("Content-Length");
        const disposition = response.headers.get("content-disposition");
        const filename = decodeURIComponent(
          disposition
            .substring(disposition.indexOf("utf-8") + 7)
            .replace(/['"]/g, "")
            .replace(";", "")
            .replace("filename=", "")
        );
        return new Response(response.body, {
          status: 206, // Partial Content
          headers: {
            "Content-Type": "application/octet-stream",
            "Content-Disposition": `attachment; filename="${filename}"`,
            "Content-Range": contentRange,
            "Content-Length": contentLength,
            "Accept-Ranges": "bytes",
          },
        });
      } else {
        const Head = new Headers();
        Head.set("Authorization", `Bearer ${this.accessToken}`);
        try {
          return await fetch(url, { headers: Head });
        } catch (error) {
          return new Response("api limited, cant handle request ", {
            status: 500,
          });
        }
      }
    } catch (error) {
      return new Response("api limited, cant handle request ", {
        status: 500,
      });
    }
  }

  Search(name: string): Promise<DriveList[]> {
    return Promise.resolve([]);
  }
}

class GDrive implements DriverIF {
  public token: string;

  constructor(token: string) {
    this.token = token;
  }

  async List(id?: string): Promise<DriveList[]> {
    const response = await fetch(
      `https://graph.microsoft.com/v1.0/drives/${id}/root/children`,
      {
        headers: {
          Authorization: `Bearer ${this.token}`,
        },
      }
    );
    const data = await response.json();
    return data.value;
  }

  async GetFile(id: string, request: any): Promise<Response> {
    return new Response("Not implemented");
  }

  async Search(name: string): Promise<DriveList[]> {
    const response = await fetch(
      `https://graph.microsoft.com/v1.0/me/drive/root/search(q='${name}')`,
      {
        headers: {
          Authorization: `Bearer ${this.token}`,
        },
      }
    );
    const data = await response.json();
    return data.value;
  }
}
